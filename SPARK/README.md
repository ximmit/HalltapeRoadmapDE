# Apache Spark


### Ð§Ñ‚Ð¾ Ñ‚Ð°ÐºÐ¾Ðµ Job - Stage - Task

> ðŸ’¡ **ÐÐ²Ñ‚Ð¾Ñ€ Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð°Ð»Ð°:**  
> [**ÐÐ½Ð½Ð° Ð‘Ð¾Ð±ÐºÐ¾Ð²Ð°**](https://t.me/iamannabo)  
> ðŸ“¡ [**Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ Ð½Ð° Ð¸Ð½Ð¶ÐµÐ½ÐµÑ€Ð½Ð¾Ð¼**](https://t.me/chtotonainzhenernom) â€” Telegram-ÐºÐ°Ð½Ð°Ð» Ð¾ Ð´Ð°Ñ‚Ð° Ð¸Ð½Ð¶Ð¸Ð½Ð¸Ñ€Ð¸Ð½Ð³Ðµ.

<p align="center">
    <img src="../png/spark_stages.jpg" alt="spark" width="600"/>
</p>

Ð•ÑÐ»Ð¸ Ð²Ñ‹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚Ðµ Ð¿Ð¾Ð³Ñ€ÑƒÐ¶Ð°Ñ‚ÑŒÑÑ Ð² spark, Ð¾Ð´Ð½Ð¾ Ð¸Ð· Ð¿ÐµÑ€Ð²Ñ‹Ñ…, Ñ‡Ñ‚Ð¾ Ð½ÑƒÐ¶Ð½Ð¾ ÑƒÑÐ²Ð¾Ð¸Ñ‚ÑŒ - ÑÑ‚Ð¾ Ð¸ÐµÑ€Ð°Ñ€Ñ…Ð¸ÑŽ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð·Ð°Ð´Ð°Ñ‡: Job, Stage, Task.

### ÐŸÐ¾Ñ‡ÐµÐ¼Ñƒ ÑÑ‚Ð¾ Ð²Ð°Ð¶Ð½Ð¾?

ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ, Ð´ÐµÐ±Ð°Ð³Ð³Ð¸Ð½Ð³, Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÐºÐ»Ð°ÑÑ‚ÐµÑ€Ð° - Ð²ÑÑ‘ ÑÑ‚Ð¾ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð·Ð½Ð°Ð½Ð¸Ñ, ÐºÐ°Ðº Spark Ð´Ñ€Ð¾Ð±Ð¸Ñ‚ Ð²Ð°ÑˆÐ¸ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð½Ð° ÑÑ‚Ð°Ð¿Ñ‹ Ð¸ Ð·Ð°Ð´Ð°Ñ‡Ð¸.  

Ð”Ð°Ð¶Ðµ Ð²Ñ‹ÑÐ¾ÐºÐ¾ÑƒÑ€Ð¾Ð²Ð½ÐµÐ²Ñ‹Ðµ API (DataFrames, SQL) ÑÐºÑ€Ñ‹Ð²Ð°ÑŽÑ‚ RDD, Ð½Ð¾ Ð½Ðµ Ð¾Ñ‚Ð¼ÐµÐ½ÑÑŽÑ‚ Ð»Ð¾Ð³Ð¸ÐºÐ¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ñ‡ÐµÑ€ÐµÐ· Job â†’ Stage â†’ Task.

### Ð¢ÐµÑ€Ð¼Ð¸Ð½Ñ‹:

âœ”ï¸ Spark Job / Ð—Ð°Ð´Ð°Ð½Ð¸Ðµ - ÑÑ‚Ð¾ Ð²ÑÑ Ð²Ñ‹Ñ‡Ð¸ÑÐ»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð·Ð°Ð´Ð°Ñ‡Ð°, ÐºÐ¾Ñ‚Ð¾Ñ€ÑƒÑŽ Ð²Ñ‹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚Ðµ Ð² Spark Ñ‡ÐµÑ€ÐµÐ· Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ (action), Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, collect(), save(), count(). Ð¡Ð¾ÑÑ‚Ð¾Ð¸Ñ‚ Ð¸Ð· Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð¸Ð»Ð¸ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¸Ñ… Stages.
ÐŸÑ€Ð¸Ð¼ÐµÑ€: Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð´Ð°Ñ‚Ð°ÑÐµÑ‚Ð° Ð¾Ñ‚ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð¾ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°.  

âœ”ï¸ Spark Stage / Ð­Ñ‚Ð°Ð¿ - Ð»Ð¾Ð³Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ ÑÑ‚Ð°Ð¿ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Job, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½ÑÐµÑ‚ Ð·Ð°Ð´Ð°Ñ‡Ð¸, Ð½Ðµ Ñ‚Ñ€ÐµÐ±ÑƒÑŽÑ‰Ð¸Ðµ Ð¾Ð±Ð¼ÐµÐ½Ð° Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð¼ÐµÐ¶Ð´Ñƒ ÑƒÐ·Ð»Ð°Ð¼Ð¸ (shuffle). Ð Ð°Ð·Ð´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð½Ð° Stages Ð¿Ñ€Ð¾Ð¸ÑÑ…Ð¾Ð´Ð¸Ñ‚ Ð¿Ñ€Ð¸ ÑˆÐ¸Ñ€Ð¾ÐºÐ¸Ñ… Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ð½Ð¸ÑÑ… (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, join, groupBy, repartition), ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ñ‚Ñ€ÐµÐ±ÑƒÑŽÑ‚ shuffle.  
ÐŸÑ€Ð¸Ð¼ÐµÑ€:  filter â†’ map â†’ reduceByKey
ÐŸÐµÑ€Ð²Ñ‹Ðµ Ð´Ð²Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ (ÑƒÐ·ÐºÐ¸Ðµ) Ð¾ÑÑ‚Ð°ÑŽÑ‚ÑÑ Ð² Stage 1, reduceByKey (ÑˆÐ¸Ñ€Ð¾ÐºÐ¾Ðµ) Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Stage 2.

âœ”ï¸ Spark Task / Ð—Ð°Ð´Ð°Ñ‡Ð° - Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ ÐµÐ´Ð¸Ð½Ð¸Ñ†Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð² Spark. ÐšÐ°Ð¶Ð´Ð°Ñ Task Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð¾Ð´Ð½Ñƒ Ð¿Ð°Ñ€Ñ‚Ð¸Ñ†Ð¸ÑŽ Ð´Ð°Ð½Ð½Ñ‹Ñ…. Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð¾ Ð½Ð° Ð¸ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑÑ… (executors).  
ÐŸÑ€Ð¸Ð¼ÐµÑ€: Ð•ÑÐ»Ð¸ Ð²Ð°Ñˆ DataFrame Ð¸Ð¼ÐµÐµÑ‚ 200 Ð¿Ð°Ñ€Ñ‚Ð¸Ñ†Ð¸Ð¹, Ð´Ð»Ñ Stage Ð±ÑƒÐ´ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½Ð¾ 200 Tasks.

### ÐšÐ°Ðº ÑÑ‚Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð½Ð° Ð¿Ñ€Ð°ÐºÑ‚Ð¸ÐºÐµ?
1. Job Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ÑÑ Ð² spark (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð²Ñ‹Ð·Ð¾Ð² df.write.csv("file")).
2. DAG Scheduler Ñ€Ð°Ð·Ð±Ð¸Ð²Ð°ÐµÑ‚ Job Ð½Ð° Stages Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ ÑˆÐ¸Ñ€Ð¾ÐºÐ¸Ñ… Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ð½Ð¸Ð¹.  
3. ÐšÐ°Ð¶Ð´Ð°Ñ Stage Ð´ÐµÐ»Ð¸Ñ‚ÑÑ Ð½Ð° Tasks Ð¿Ð¾ Ñ‡Ð¸ÑÐ»Ñƒ Ð¿Ð°Ñ€Ñ‚Ð¸Ñ†Ð¸Ð¹.
4. Tasks Ñ€Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÑŽÑ‚ÑÑ Ð¼ÐµÐ¶Ð´Ñƒ executorâ€™Ð°Ð¼Ð¸ Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÑŽÑ‚ÑÑ Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð¾.
5. Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Tasks Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½ÑÑŽÑ‚ÑÑ, Ð¸ Job Ð·Ð°Ð²ÐµÑ€ÑˆÐ°ÐµÑ‚ÑÑ.

### ÐŸÑ€Ð¸Ð¼ÐµÑ€:
```python
df = spark.read.csv("data.csv")  
df_filtered = df.filter(df["age"] > 20) # Ð£Ð·ÐºÐ¾Ðµ Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ð½Ð¸Ðµ (Stage 1)  
df_repartitioned = df_filtered.repartition(10) # Ð¨Ð¸Ñ€Ð¾ÐºÐ¾Ðµ Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ð½Ð¸Ðµ (Stage 2)  
df_grouped = df_repartitioned.groupBy("city").count() # Ð¨Ð¸Ñ€Ð¾ÐºÐ¾Ðµ Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ð½Ð¸Ðµ (Stage 3)  
df_grouped.write.csv("result") # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Job
```
Ð˜Ñ‚Ð¾Ð³:
- 1 Job (Ð·Ð°Ð¿Ð¸ÑÑŒ Ð² CSV),
- 3 Stages (Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ñ â†’ Ñ€ÐµÐ¿Ð°Ñ€Ñ‚Ð¸Ñ†Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ â†’ Ð°Ð³Ñ€ÐµÐ³Ð°Ñ†Ð¸Ñ),
- N Tasks (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, 10 Ð·Ð°Ð´Ð°Ñ‡ Ð² Stage 3 Ð¿Ð¾ÑÐ»Ðµ repartition(10)).


### ÐŸÐ¾Ñ‡ÐµÐ¼Ñƒ Ð² Spark UI Ð¸Ð½Ð¾Ð³Ð´Ð° Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°ÐµÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ð´Ð¸Ð½ Stage?
- ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹ Ñ shuffle: ÐµÑÐ»Ð¸ Ð²ÑÐµ Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ð½Ð¸Ñ ÑƒÐ·ÐºÐ¸Ðµ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, filter, select), spark Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ Ð¸Ñ… Ð² Ð¾Ð´Ð½Ð¾Ð¹ Stage.  
- ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Catalyst: Ð² spark SQL/DataFrames Catalyst Optimizer Ð¼Ð¾Ð¶ÐµÑ‚ Ð¿ÐµÑ€ÐµÑƒÐ¿Ð¾Ñ€ÑÐ´Ð¾Ñ‡Ð¸Ð²Ð°Ñ‚ÑŒ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸, Ð¸Ð·Ð±ÐµÐ³Ð°Ñ Ð½ÐµÐ½ÑƒÐ¶Ð½Ñ‹Ñ… shuffle.
ÐŸÑ€Ð¸Ð¼ÐµÑ€: df.groupBy(...).filter(...) â†’ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ð´Ð¾ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ¸.  
- ÐŸÑ€ÐµÐ´Ð²Ð°Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¿Ð°Ñ€Ñ‚Ð¸Ñ†Ð¸Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ: ÐµÑÐ»Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÑƒÐ¶Ðµ Ñ€Ð°Ð·Ð´ÐµÐ»ÐµÐ½Ñ‹ Ð¿Ð¾ ÐºÐ»ÑŽÑ‡Ñƒ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð¿Ð¾ÑÐ»Ðµ repartition("key")), groupBy Ð¼Ð¾Ð¶ÐµÑ‚ Ð½Ðµ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ñ‚ÑŒ shuffle.  
- ÐœÐ°Ð»ÐµÐ½ÑŒÐºÐ¸Ð¹ Ð¾Ð±ÑŠÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ñ…: ÐµÑÐ»Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð¼ÐµÑ‰Ð°ÑŽÑ‚ÑÑ Ð² Ð¿Ð°Ð¼ÑÑ‚ÑŒ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð¸ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»Ñ, spark Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð¸Ñ… Ð±ÐµÐ· Ñ€Ð°Ð·Ð´ÐµÐ»ÐµÐ½Ð¸Ñ Ð½Ð° Ð·Ð°Ð´Ð°Ñ‡Ð¸.

### Ð¡Ð¾Ð²ÐµÑ‚Ñ‹ Ð´Ð»Ñ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸:
- Ð¡Ð»ÐµÐ´Ð¸Ñ‚Ðµ Ð·Ð° shuffle: ÐºÐ°Ð¶Ð´Ð¾Ðµ ÑˆÐ¸Ñ€Ð¾ÐºÐ¾Ðµ Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐ¾Ð·Ð´Ð°ÐµÑ‚ Ð½Ð¾Ð²Ñ‹Ð¹ Stage. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ broadcast Ð´Ð»Ñ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÐ¸Ñ… Ñ‚Ð°Ð±Ð»Ð¸Ñ† Ð² join.
### ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ Ð¿Ð°Ñ€Ñ‚Ð¸Ñ†Ð¸Ð¸:
    âž•Ð¡Ð»Ð¸ÑˆÐºÐ¾Ð¼ Ð¼Ð½Ð¾Ð³Ð¾ Ð¿Ð°Ñ€Ñ‚Ð¸Ñ†Ð¸Ð¹ â†’ Ð¼Ð½Ð¾Ð³Ð¾ Ð¼ÐµÐ»ÐºÐ¸Ñ… Tasks (Ñ€Ð¸ÑÐº Ð¿ÐµÑ€ÐµÐ³Ñ€ÑƒÐ·ÐºÐ¸ Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ñ‰Ð¸ÐºÐ°).
    âž•Ð¡Ð»Ð¸ÑˆÐºÐ¾Ð¼ Ð¼Ð°Ð»Ð¾ â†’ Ð½ÐµÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»Ð¸Ð·Ð¼.
    âž•Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ coalesce Ð´Ð»Ñ ÑƒÐ¼ÐµÐ½ÑŒÑˆÐµÐ½Ð¸Ñ Ñ‡Ð¸ÑÐ»Ð° Ð¿Ð°Ñ€Ñ‚Ð¸Ñ†Ð¸Ð¹ Ð±ÐµÐ· shuffle.
### Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Spark UI:
- ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð²Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Stages (Ð²ÐºÐ»Ð°Ð´ÐºÐ° Stages), Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐ¹Ñ‚Ðµ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð¿ÐµÑ€ÐµÐºÐ¾ÑÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… (Skew) Ð¸ Spill (Memory/Disk).  

### Ð§Ñ‚Ð¾ Ð² Ð¸Ñ‚Ð¾Ð³Ðµ?
1. Spark-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ (action) â†’ ÑÐ¾Ð·Ð´Ð°ÐµÑ‚ÑÑ Job.
2. Job Ñ€Ð°Ð·Ð±Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ð½Ð° Stages Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ ÑˆÐ¸Ñ€Ð¾ÐºÐ¸Ñ… Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ð½Ð¸Ð¹.
3. ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Stage ÑÐ¾ÑÑ‚Ð¾Ð¸Ñ‚ Ð¸Ð· Tasks (Ð¿Ð¾ Ð¾Ð´Ð½Ð¾Ð¹ Ð½Ð° Ð¿Ð°Ñ€Ñ‚Ð¸Ñ†Ð¸ÑŽ).  
4. Tasks Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÑŽÑ‚ÑÑ Ð½Ð° Ð¸ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑÑ… (executors). ÐžÐ´Ð¸Ð½ Ð¸ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒ Ð¼Ð¾Ð¶ÐµÑ‚ Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°Ñ‚ÑŒ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Tasks Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð¾.
   
### Ð¥Ð¸Ð½Ñ‚Ñ‹ Ð² Spark ðŸª„

Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ Ñ€Ð°ÑÑÐºÐ°Ð¶Ñƒ Ð¿Ñ€Ð¾ Â«ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹Â», ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¿Ð¾Ð¼Ð¾Ð³Ð°ÑŽÑ‚ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð·Ð°Ð´Ð°Ñ‡, ÐºÐ¾Ð³Ð´Ð° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ‚Ð¾Ñ€ Ð½Ðµ ÑÐ¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ÑÑ. Ð Ð°Ð·Ð±ÐµÑ€ÐµÐ¼ÑÑ, ÐºÐ°ÐºÐ¸Ðµ Ñ…Ð¸Ð½Ñ‚Ñ‹ Ð±Ñ‹Ð²Ð°ÑŽÑ‚, ÐºÐ°Ðº Ð¸Ñ… Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸ Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ Ð¾Ð½Ð¸ Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚.

**Ð’Ð°Ð¶Ð½Ð¾: Ñ…Ð¸Ð½Ñ‚Ñ‹ Ð½Ðµ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ€ÑƒÑŽÑ‚ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚, Ð½Ð¾ Ð² 90% ÑÐ»ÑƒÑ‡Ð°ÐµÐ² spark Ð¸Ñ… ÑƒÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÑ‚**

## âœ³ï¸ ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ñ‚Ð¸Ð¿Ñ‹ Ñ…Ð¸Ð½Ñ‚Ð¾Ð² Ð² Spark

### ðŸ”— **Ð¥Ð¸Ð½Ñ‚Ñ‹ Ð´Ð»Ñ JOIN'Ð¾Ð²**
ÐŸÐ¾Ð¼Ð¾Ð³Ð°ÑŽÑ‚ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ†:

- **â–«ï¸ BROADCAST**  
  Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ *Broadcast Join* â€” Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Broadcast Join (Ð¼Ð°Ð»ÐµÐ½ÑŒÐºÐ°Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð° ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ð½Ð° Ð²ÑÐµ Ð½Ð¾Ð´Ñ‹).

- **â–«ï¸ MERGE**  
  ÐŸÐ¾Ð´ÑÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚, Ñ‡Ñ‚Ð¾ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ñ‚ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ Ð¸ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ *Merge Join*.  
  âš ï¸ ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ **Ð·Ð°Ñ€Ð°Ð½ÐµÐµ Ð¾Ñ‚ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹** Ð¿Ð¾ ÐºÐ»ÑŽÑ‡Ñƒ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ.

- **â–«ï¸ SHUFFLE_HASH**  
  ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ *Shuffle Hash Join*.  
  ÐŸÐ¾Ð»ÐµÐ·ÐµÐ½ Ð¿Ñ€Ð¸ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ð¸ **Ð±Ð¾Ð»ÑŒÑˆÐ¸Ñ… Ñ‚Ð°Ð±Ð»Ð¸Ñ†**, ÐºÐ¾Ð³Ð´Ð° ÐºÐ»ÑŽÑ‡Ð¸ Ð»ÐµÐ³ÐºÐ¾ Ñ…ÐµÑˆÐ¸Ñ€ÑƒÑŽÑ‚ÑÑ.

### ðŸ“¦ Ð¥Ð¸Ð½Ñ‚Ñ‹ Ð´Ð»Ñ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ð°Ñ€Ñ‚Ð¸Ñ†Ð¸ÑÐ¼Ð¸

ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»Ð¸Ñ€ÑƒÑŽÑ‚, ÐºÐ°Ðº Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ€Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÑŽÑ‚ÑÑ Ð¼ÐµÐ¶Ð´Ñƒ Ð½Ð¾Ð´Ð°Ð¼Ð¸ Ð² ÐºÐ»Ð°ÑÑ‚ÐµÑ€Ðµ:

- **â–«ï¸ REPARTITION**  
  ÐŸÐµÑ€ÐµÑ€Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ‡ÐµÑ€ÐµÐ· Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ shuffle, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑƒÐ²ÐµÐ»Ð¸Ñ‡Ð¸Ñ‚ÑŒ/ÑƒÐ¼ÐµÐ½ÑŒÑˆÐ¸Ñ‚ÑŒ Ñ‡Ð¸ÑÐ»Ð¾ Ð¿Ð°Ñ€Ñ‚Ð¸Ñ†Ð¸Ð¹ Ð¸Ð»Ð¸ Ð¿Ð°Ñ€Ñ‚Ð¸Ñ†Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð¾ ÑÑ‚Ð¾Ð»Ð±Ñ†Ñƒ.

- **â–«ï¸ COALESCE**  
  Ð£Ð¼ÐµÐ½ÑŒÑˆÐ°ÐµÑ‚ Ñ‡Ð¸ÑÐ»Ð¾ Ð¿Ð°Ñ€Ñ‚Ð¸Ñ†Ð¸Ð¹ Ð±ÐµÐ· shuffle (Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½ÑÐµÑ‚ ÑÐ¾ÑÐµÐ´Ð½Ð¸Ðµ).  ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÑ‚ÑÑ Ð¿Ð¾ÑÐ»Ðµ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ð¸, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð±ÐµÐ¶Ð°Ñ‚ÑŒ Ð¼ÐµÐ»ÐºÐ¸Ñ… Ð¿Ð°Ñ€Ñ‚Ð¸Ñ†Ð¸Ð¹.

- **â–«ï¸ REBALANCE**  
  ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð±Ð°Ð»Ð°Ð½ÑÐ¸Ñ€ÑƒÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ, Ð¼Ð¸Ð½Ð¸Ð¼Ð¸Ð·Ð¸Ñ€ÑƒÑ Ð¿ÐµÑ€ÐµÐºÐ¾ÑÑ‹.
 
### âš–ï¸ Ð¥Ð¸Ð½Ñ‚ Ð´Ð»Ñ Ð±Ð¾Ñ€ÑŒÐ±Ñ‹ Ñ Ð¿ÐµÑ€ÐµÐºÐ¾ÑÐ°Ð¼Ð¸ (Data Skew)

- **â–«ï¸ SKEW**  
  Ð£ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ spark Ð½Ð° Ð¿ÐµÑ€ÐµÐºÐ¾ÑˆÐµÐ½Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ Ð¸ Ñ‡Ð¸ÑÐ»Ð¾ Ð¿Ð°Ñ€Ñ‚Ð¸Ñ†Ð¸Ð¹. 


ÐšÑÑ‚Ð°Ñ‚Ð¸, ÐµÑÐ»Ð¸ Ð² Spark UI Ð²Ð¸Ð´Ð¸Ñ‚Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÑŽÑ‚ÑÑ Ð² 10 Ñ€Ð°Ð· Ð´Ð¾Ð»ÑŒÑˆÐµ Ð´Ñ€ÑƒÐ³Ð¸Ñ… â€” ÑÑ‚Ð¾ skew. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ñ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ñ…Ð¸Ð½Ñ‚ SKEW Ð¸Ð»Ð¸ REBALANCE

### Ð§Ñ‚Ð¾ Ð¿Ð¾ ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸ÑÑƒ?
Ð’ sql: Ñ…Ð¸Ð½Ñ‚ Ð¿ÐµÑ€ÐµÐ´Ð°ÐµÑ‚ÑÑ Ð² ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ñ‹ /*+ ... */ Ð¿Ð¾ÑÐ»Ðµ select.
```sql
SELECT /*+ MERGE */ 
    t1.*, t2.* 
FROM table1 t1 
JOIN table2 t2 ON t1.sorted_key = t2.sorted_key;
Ð’ spark: Ñ‡ÐµÑ€ÐµÐ· Ð¼ÐµÑ‚Ð¾Ð´ hint()
df.hint("rebalance", "user_id")
```
**ÐŸÐ¾Ñ‡ÐµÐ¼Ñƒ Ñ…Ð¸Ð½Ñ‚Ñ‹ Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚?**

â€” ÐŸÑ€Ð¾Ñ‚Ð¸Ð²Ð¾Ñ€ÐµÑ‡Ð°Ñ‚ Ð»Ð¾Ð³Ð¸ÐºÐµ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ‚Ð¾Ñ€Ð°. ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, ÐµÑÐ»Ð¸ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð° Ð´Ð»Ñ BROADCAST ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ Ð±Ð¾Ð»ÑŒÑˆÐ°Ñ, spark Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ Sort-Merge Join Ð²Ð¼ÐµÑÑ‚Ð¾ Broadcast.

â€” Ð’ÐµÑ€ÑÐ¸Ñ Ð²Ð°ÑˆÐµÐ³Ð¾ spark. Ð¥Ð¸Ð½Ñ‚Ñ‹ Ð²Ñ€Ð¾Ð´Ðµ SKEW Ð¸Ð»Ð¸ REBALANCE Ñ‚Ñ€ÐµÐ±ÑƒÑŽÑ‚ spark 3.0+

â€” Ð§Ñ‚Ð¾-Ñ‚Ð¾ Ð² Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð°Ñ… ÑÐµÑÑÐ¸Ð¸. ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½ AQE, Ð¾Ð½ Ð¼Ð¾Ð¶ÐµÑ‚ Ð¿ÐµÑ€ÐµÐ¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÑÑ‚ÑŒ Ñ…Ð¸Ð½Ñ‚Ñ‹.


## Ð’Ð»Ð¸ÑÐµÑ‚ Ð»Ð¸ Ñ‚Ð¸Ð¿ Ð´Ð¶Ð¾Ð¹Ð½Ð° Ð½Ð° Ð²Ñ‹Ð±Ð¾Ñ€ Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼Ð°?

Ð”Ð°, Ñ‚Ð¸Ð¿ Ð´Ð¶Ð¾Ð¹Ð½Ð° Ð¼Ð¾Ð¶ÐµÑ‚ Ð²Ð»Ð¸ÑÑ‚ÑŒ Ð½Ð° Ð²Ñ‹Ð±Ð¾Ñ€ Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼Ð°, Ð½Ð¾ Ð½Ðµ Ð²ÑÐµÐ³Ð´Ð° Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÑŽ Ð¾Ð±ÑŠÑÑÐ½Ð¸Ñ‚ÑŒ Ñ‡ÑƒÑ‚ÑŒ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½ÐµÐµ.

Ð’Ð¾Ð·ÑŒÐ¼ÐµÐ¼ inner join, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÐ¾Ð²Ð¿Ð°Ð´Ð°ÑŽÑ‰Ð¸Ðµ ÑÑ‚Ñ€Ð¾ÐºÐ¸, ÐµÐ¼Ñƒ Ð²Ð¾Ð¾Ð±Ñ‰Ðµ Ð¿Ð¾Ð´Ñ…Ð¾Ð´Ð¸Ñ‚ Ð»ÑŽÐ±Ð¾Ð¹ Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼: Ð½Ð¾, Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Hash Join Ð±ÑƒÐ´ÐµÑ‚ ÑÐ°Ð¼Ñ‹Ð¼ ÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¼, ÐµÑÐ»Ð¸ Ð¾Ð´Ð½Ð° Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð° Ð¿Ð¾Ð¼ÐµÑ‰Ð°ÐµÑ‚ÑÑ Ð² Ð¿Ð°Ð¼ÑÑ‚ÑŒ Ð¸Ð»Ð¸ Sort-Merge Ð¿Ñ€Ð¸ Ð´Ð¶Ð¾Ð¹Ð½Ðµ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ñ… Ð¾Ñ‚ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ñ‚Ð°Ð±Ð»Ð¸Ñ†.

ÐÐµÐ¼Ð½Ð¾Ð³Ð¾ Ð´Ñ€ÑƒÐ³Ð°Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ñ left/right Ð´Ð¶Ð¾Ð¹Ð½Ð°Ð¼Ð¸: Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼Ñ‹ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ ÑƒÐ¼ÐµÑ‚ÑŒ Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°Ñ‚ÑŒ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ ÐºÐ»ÑŽÑ‡Ð¸.  

Hash Join: Ð² Ñ†ÐµÐ»Ð¾Ð¼ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ left/right Ð´Ð¶Ð¾Ð¹Ð½Ñ‹, Ð½Ð¾ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… ÑˆÐ°Ð³Ð¾Ð², Ñ‚Ð¸Ð¿Ð°:  
- ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð²ÑÐµÑ… ÑÑ‚Ñ€Ð¾Ðº Ð¸Ð· Ð³Ð»Ð°Ð²Ð½Ð¾Ð¹ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ (Ð»ÐµÐ²Ð¾Ð¹ Ð´Ð»Ñ left join)
- Ð·Ð°Ñ‚ÐµÐ¼ Ð¾Ñ‚Ð¼ÐµÑ‚ÐºÐ° Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… ÑÐ¾Ð²Ð¿Ð°Ð´ÐµÐ½Ð¸Ð¹ -> Ð¼Ð¾Ð¶ÐµÑ‚ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ñ‚ÑŒ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð¿Ð°Ð¼ÑÑ‚Ð¸.  
  
ÐŸÐ¾ÑÑ‚Ð¾Ð¼Ñƒ Ð»ÑƒÑ‡ÑˆÐµ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Sort-Merge Join: Ñ‚Ð°Ðº ÐºÐ°Ðº ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ° Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð»ÐµÐ³ÐºÐ¾ Ð½Ð°Ð¹Ñ‚Ð¸ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ ÐºÐ»ÑŽÑ‡Ð¸.  

Ð¡Ð»Ð¾Ð¶Ð½ÐµÐµ Ñ full outer join: Ð¾Ð½ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð²ÑÐµ ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ð¸Ð· Ð¾Ð±ÐµÐ¸Ñ… Ñ‚Ð°Ð±Ð»Ð¸Ñ† Ð¸ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð¿Ð¾Ð»Ð½Ð¾Ð¹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð¾Ð±ÐµÐ¸Ñ… Ñ‚Ð°Ð±Ð»Ð¸Ñ†, Ð¿Ð¾ÑÑ‚Ð¾Ð¼Ñƒ Ð´Ð»Ñ Ð½ÐµÐ³Ð¾: 
- Ð¢Ð¾Ñ‡Ð½Ð¾ Ð½ÐµÑ‚: Nested Loop Join - Ð½ÐµÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²ÐµÐ½ Ð¸Ð·-Ð·Ð° ÑÐ»Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ O(N*M).  
- Hash Join - Ð¼Ð¾Ð¶Ð½Ð¾, Ð½Ð¾ Ñ€ÐµÐ´ÐºÐ¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ, Ñ‚Ð°Ðº ÐºÐ°Ðº Ð½ÑƒÐ¶Ð½Ð¾ Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ñ…ÐµÑˆ-Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ Ð´Ð»Ñ Ð¾Ð±ÐµÐ¸Ñ… Ñ‚Ð°Ð±Ð»Ð¸Ñ† (Ð¼Ð¾Ð¶Ð½Ð¾ Ð²ÑÑ‚Ñ€ÐµÑ‚Ð¸Ñ‚ÑŒ Ð² PostgreSQL Ð´Ð»Ñ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÐ¸Ñ… Ñ‚Ð°Ð±Ð»Ð¸Ñ†)
- Ð¢Ð¾Ñ‡Ð½Ð¾ Ð´Ð°: Sort-Merge Join - Ð¾Ð¿Ñ‚Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð²Ñ‹Ð±Ð¾Ñ€, Ñ‚Ð°Ðº ÐºÐ°Ðº ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ° Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð´Ð°Ð½Ð½Ñ‹Ðµ (spark Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Ð¿Ð¾Ñ‡Ñ‚Ð¸ Ð²ÑÐµÐ³Ð´Ð°)

Ð•ÑÐ»Ð¸ Ð²Ð´Ñ€ÑƒÐ³ Ð²Ñ‹ Ñ€ÐµÑˆÐ¸Ð»Ð¸ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ Ð´ÐµÐºÐ°Ñ€Ñ‚Ð¾Ð²Ð¾ Ð¿Ñ€Ð¾Ð¸Ð·Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ (cross join ðŸ¥´), Ñ‚Ð¾ Ñ‚ÑƒÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Nested Loop Join (Ð¸Ð»Ð¸ ÐµÐ³Ð¾ Ð»ÑƒÑ‡ÑˆÐ¸Ðµ Ð²ÐµÑ€ÑÐ¸Ð¸), Ð¿Ð¾ÑÐºÐ¾Ð»ÑŒÐºÑƒ Ð¿Ñ€Ð¾Ð¸ÑÑ…Ð¾Ð´Ð¸Ñ‚ Ð´Ð¶Ð¾Ð¹Ð½ ÐºÐ°Ð¶Ð´Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ð¾Ð´Ð½Ð¾Ð¹ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ Ñ ÐºÐ°Ð¶Ð´Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¾Ð¹ Ð´Ñ€ÑƒÐ³Ð¾Ð¹. ÐÐ¾ Ð² spark Ñ€ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð¾ Ñ‡ÐµÑ€ÐµÐ· Shuffle.

- Ð§Ñ‚Ð¾ Ñ‚Ð°Ð¼ Ñ semi join? ðŸ’…ðŸ¼ 
- Ð² Ñ†ÐµÐ»Ð¾Ð¼ Ð°Ð½Ð°Ð»Ð¾Ð³Ð¸Ñ‡ÐµÐ½ inner join, Ð¿Ð¾ÑÑ‚Ð¾Ð¼Ñƒ Ð¿Ð¾Ð´Ð¾Ð¹Ð´ÐµÑ‚ Ð»ÑŽÐ±Ð¾Ð¹ Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼.

Ð”Ð»Ñ anti join - ÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²ÐµÐ½ Hash Join Ñ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸ÐµÐ¹ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… ÐºÐ»ÑŽÑ‡ÐµÐ¹.

Ð­Ñ‚Ð¾ Ð²ÑÐµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð² ÑÐ»ÑƒÑ‡Ð°Ðµ Ñ€Ð°Ð²ÐµÐ½ÑÑ‚Ð²Ð° ÐºÐ»ÑŽÑ‡ÐµÐ¹ (Ð² Ñ‚Ð¾Ð¼ Ñ‡Ð¸ÑÐ»Ðµ Ð¸ Ð´Ð»Ñ ÑÐ¾ÑÑ‚Ð°Ð²Ð½Ñ‹Ñ… ÐºÐ»ÑŽÑ‡ÐµÐ¹).

â•Ð•ÑÐ»Ð¸ ÐºÐ»ÑŽÑ‡ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð½ÐµÑ€Ð°Ð²ÐµÐ½ÑÑ‚Ð²Ð° **(key_1 > key_2)**, Ñ‚Ð¾ Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼ **Nested Loop Join**, Ð´Ð»Ñ Ð¾Ñ‚ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… - **Sort-Merge Join**.

***



ÐÐ¸Ð¶Ðµ Ð¿Ð¾Ð»ÐµÐ·Ð½Ñ‹Ðµ Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð°Ð»Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¿Ð¾Ð¼Ð¾Ð³ÑƒÑ‚ Ð² Ð¾ÑÐ²Ð¾ÐµÐ½Ð¸Ð¸ Spark:
- [Ð¢ÐµÐ¾Ñ€Ð¸Ñ Ð¿Ð¾ Spark Ð² PDF](../files/spark.pdf)
- [ÐžÐ½Ð»Ð°Ð¹Ð½ Ñ€Ð°ÑÑ‡ÐµÑ‚ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð² Ð´Ð»Ñ Spark](https://sparkconfigoptimizer.com)
- [ÐšÐ°Ðº Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒÑÑ Spark UI?](https://habr.com/ru/companies/avito/articles/764996/)
- [Leetcode Ð¿Ð¾ PySpark](https://platform.stratascratch.com/coding?code_type=6)


ÐžÐ´Ð½Ð° Ð¸Ð· Ñ…Ð¾Ñ€Ð¾ÑˆÐ¸Ñ… Ð¿Ñ€Ð°ÐºÑ‚Ð¸Ðº Ð´Ð»Ñ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ñ - Ð¿ÐµÑ€ÐµÐ¿Ð¸ÑÑ‹Ð²Ð°Ñ‚ÑŒ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ñ SQL Ð½Ð° Spark Ð¸ Ð½Ð°Ð¾Ð±Ð¾Ñ€Ð¾Ñ‚.
Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹, Ð¾Ñ‡ÐµÐ²Ð¸Ð´Ð½Ð¾, Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ð´Ð¸Ð½Ð°ÐºÐ¾Ð²Ñ‹Ð¼Ð¸.

**Ð’Ð¾Ñ‚ Ð¿Ñ€Ð¸Ð¼ÐµÑ€ Ð´Ð²ÑƒÑ… Ð¾Ð´Ð¸Ð½Ð°ÐºÐ¾Ð²Ñ‹Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð½Ð° SQL Ð¸ Ð½Ð° PySpark**

```sql
SELECT
    d.department_name,
    AVG(s.salary) AS average_salary
FROM employees e
    JOIN departments d ON e.department_id = d.department_id
    JOIN salaries s ON e.employee_id = s.employee_id
WHERE s.salary >= 3000
GROUP BY d.department_name
ORDER BY average_salary DESC;
```


```python
result_df = employees_df\
                .join(departments_df, "department_id")\
                .join(salaries_df, "employee_id")
                .filter(salaries_df.salary >= 3000)
                .groupBy("department_name")
                .agg(F.avg("salary").alias("average_salary"))
                .orderBy(F.desc("average_salary"))
result_df.show()
```